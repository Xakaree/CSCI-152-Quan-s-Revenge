<!DOCTYPE HTML>
<html>

<head>
    <title>Fighting Game</title>
    <style type="text/css">
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: grey;
        }

        #layer1, #layer0 {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            max-height: 100%;
            margin: auto;
        }
    </style>
</head>

<body>
    <div style="text-align:center">
    <canvas id="layer1" width="1280" height="720" style="position:absolute; left:0px; top:0px; z-index: 2;"></canvas>
    <canvas id="layer0" width="1280" height="720" style="position:absolute; left:0px; top:0px; z-index: 1;"></canvas>
    </div>
</body>

<script type="text/javascript">
    var background = document.getElementById("layer0");
    var canvas = document.getElementById("layer1");
    var ctx0 = background.getContext("2d");
    var ctx1 = canvas.getContext("2d");

    var fps = 60;
    var interval = 1/fps;
    console.log(interval);
    var oldTime, newTime, deltaTime = 0;
    

    var width = 1280;
    var height = 720;
    var tileSize = 40;

    //Draw tile grid -- TEMPORARY
    ctx0.fillStyle = "grey";
    ctx0.fillRect(0,0,width,height);
    ctx0.fillStyle = "black";
    for(var i = 0; i < width/tileSize; i++) {
        for(var j = 0; j < height/tileSize; j++) {
            ctx0.rect(i*tileSize,j*tileSize,tileSize,tileSize);
        }
    }
    ctx0.stroke();

    //initialize input array of bools -- use input[keycode] to see if key pressed
    var input = new Array(91);
    for (var i = 0; i < input.length; i++) {
        input[i] = false;
    }

    document.addEventListener('keydown',doKeyDown,false);
    document.addEventListener('keyup',doKeyRelease,false);

    function doKeyDown(e) {
        var key = e.keyCode;
        input[key] = true;
    }

    function doKeyRelease(e) {
        var key = e.keyCode;
        input[key] = false;
    }

    function Entity(x,y,w,h,tag) {
        this.x = x;
        this.y = y;
        this.vx = 0.0;
        this.vy = 0.0;
        this.ax = 0.0;
        this.ay = 0.0;
        this.width = w;
        this.height = h;
        this.tag = tag;

        this.getTop = function() {return this.y;}
        this.getRight = function() {return this.x + this.width;}
        this.getBot = function() {return this.y + this.height;}
        this.getLeft = function() {return this.x;}

        this.getMidX = function() {return this.x + (this.width/2);}
        this.getMidY = function() {return this.y + (this.height/2);}
    }

    function collisionCheck(collider, collidee) {
        var l1 = collider.entity.getLeft();
        var r1 = collider.entity.getRight();
        var b1 = collider.entity.getBot();
        var t1 = collider.entity.getTop();

        var l2 = collidee.entity.getLeft();
        var r2 = collidee.entity.getRight();
        var b2 = collidee.entity.getBot();
        var t2 = collidee.entity.getTop();

        if(b1 < t2 || t1 > b2 || r1 < l2 || l1 > r2) {
            return false;
        }
        else return true;
    }

    function collision(collider, collidee) {
        if(collider.onCollision) {
            collider.onCollision(collidee);
        }
        if(collidee.onCollision) {
            collidee.onCollision(collider);
        }
    }

    function SolidTile(cx,cy,cw,ch) {
        this.entity = new Entity(cx*tileSize,cy*tileSize, cw*tileSize,ch*tileSize, "solid");

        this.Update = function() {

        }

        this.Draw = function() {
            ctx1.fillStyle = "black";
            ctx1.fillRect(this.entity.x,this.entity.y,this.entity.width,this.entity.height);
        }

    }

    function Player(x, y,w,h, controls, color) {
        this.entity = new Entity(x,y,w,h,"player");
        this.speed = 350.0;
        this.accel = 5.0;
        this.grav = 3000.0;
        this.controls = controls || defaultcontrols;

        this.jumping = false;

        this.Update = function() {
            if(input[this.controls.left]) this.entity.vx = -this.speed;
            else if(input[this.controls.right]) this.entity.vx = this.speed;
            else this.entity.vx = 0.0;
            if(input[this.controls.jump] && !this.jumping) {
                this.entity.vy = -1100.0;
                this.jumping = true;
            } 

            /*this.entity.vx += this.entity.ax * deltaTime;
            this.entity.vy += (this.entity.ay * deltaTime) + (this.grav * deltaTime);

            this.entity.x += this.entity.vx * deltaTime;
            this.entity.y += Math.min(40, this.entity.vy * deltaTime);*/

            this.entity.vx += this.entity.ax * interval;
            this.entity.vy += (this.entity.ay * interval) + (this.grav * interval);

            this.entity.x += Math.min(40, this.entity.vx * interval);
            this.entity.y += Math.min(40, this.entity.vy * interval);
            //console.log(this.entity.vy);
        }

        this.onCollision = function(collider) {
            if(collider.entity.tag == "player") {

            }
            if(collider.entity.tag == "solid") {
                var dx = (collider.entity.getMidX() - this.entity.getMidX()) / (collider.entity.width/2);
                var dy = (collider.entity.getMidY() - this.entity.getMidY()) / (collider.entity.height/2);
                var absDx = Math.abs(dx);
                var absDy = Math.abs(dy);


                if(Math.abs(absDx - absDy) < 0.01) {
                    if(dx < 0) {
                        this.entity.x = collider.entity.getRight();
                    }
                    else {
                        this.entity.x = collider.entity.getLeft() - this.entity.width;
                    }
                    if(dy < 0) {
                        this.entity.y = collider.entity.getBot();
                    }
                    else {
                        this.entity.y = collider.entity.getTop() - this.entity.height;
                    }
                }
                if(absDx > absDy) {
                    if(dx < 0) {
                        this.entity.x = collider.entity.getRight();
                    }
                    else {
                        this.entity.x = collider.entity.getLeft() - this.entity.width;
                    }
                }
                else {
                    if(dy < 0) {
                        this.entity.y = collider.entity.getBot();
                        this.entity.vy = 0;
                    }
                    else {
                        this.entity.y = collider.entity.getTop() - this.entity.height;
                        this.entity.vy = 0;
                        this.entity.ay = 0;
                        this.jumping = false;
                    }
                }
            }
            
        }

        this.Draw = function() {
            ctx1.fillStyle = color;
            ctx1.fillRect(this.entity.x,this.entity.y,this.entity.width,this.entity.height);
        }
    }

    var defaultcontrols = {
        left: null,
        right: null,
        up: null,
        down: null,
        jump: null
    }

    var p1controls = {
        left: 37,
        right: 39,
        up: 38,
        down: 40,
        jump: 38
    }

    var p2controls = {
        left: 65,
        right: 68,
        up: 87,
        down: 83,
        jump: 87
    }

    function Camera() { 
        this.x = 0;
        this.y = 0;
        this.width = canvas.width;
        this.height = canvas.height;

        this.Update = function(player) {
            this.x = Math.floor(player.entity.x + (player.entity.width/2) - (this.width/2));
            this.y = Math.floor(player.entity.y + (player.entity.height/2) - (this.height/2));

            if(this.x < 0) {
                this.x = 0;
            }
            if(this.x + this.width > width) {
                this.x = width - this.width;
            }
            if(this.y < 0) {
                this.y = 0;
            }
            if(this.y + this.height > height) {
                this.y = height - this.height;
            }



            
        }
    }

    function Scene() {
        this.entities = [];
        this.collisions = [];
        //this.camera = new Camera();

        this.Start = function() {

            //test objects
            var p1 = new Player(400,100,40,40,p1controls, "green");
            this.entities.push(p1);
            var p2 = new Player(800,400,40,40,p2controls, "blue");
            this.entities.push(p2);
            this.entities.push(new SolidTile(8,11,15,1));
            this.entities.push(new SolidTile(10,7,3,1));
            this.entities.push(new SolidTile(18,7,3,1));
            this.entities.push(new SolidTile(0,0,width/tileSize,1));
            this.entities.push(new SolidTile(0,height/tileSize - 1,width/tileSize,1));
            this.entities.push(new SolidTile(0,1,1,height/tileSize-2));
            this.entities.push(new SolidTile(width/tileSize-1,1,1,height/tileSize-2));
        }

        this.Update  = function() {
            for(var i = 0; i < this.entities.length; i++) {
                this.entities[i].Update();
            }
            this.checkCollisions();
            this.runCollisions();

        }

        this.checkCollisions = function() {
            this.collisions = [];
            for(var i = 0; i < this.entities.length; i++) {
                for(var j = i+1; j < this.entities.length; j++) {
                    if(collisionCheck(this.entities[i], this.entities[j])) {
                        this.collisions.push([this.entities[i], this.entities[j]]);
                    }
                }
            }
        }

        this.runCollisions = function() {
            for(var i = 0; i < this.collisions.length; i++) {
                collision(this.collisions[i][0], this.collisions[i][1]);
            }
        }

        this.Draw = function() {
            ctx1.clearRect(0,0,canvas.width,canvas.height);

            ctx1.save();
            ctx0.save();

            /*this.camera.Update(this.entities[0]);

            ctx0.translate(-this.camera.x, -this.camera.y);
            ctx1.translate(-this.camera.x, -this.camera.y);*/
            

            for(var i = 0; i < this.entities.length; i++) {
                this.entities[i].Draw();
            }

            ctx0.restore();
            ctx1.restore();
        }
    }

    function GameLoop() {
        newTime = performance.now();
        deltaTime = deltaTime + Math.min(1, (newTime - oldTime)/1000);
        oldTime = newTime;

        while(deltaTime >= interval) {
            deltaTime -= interval;
            Scene.Update();
        }
        Scene.Draw();

        requestAnimationFrame(GameLoop);
    }

    Scene = new Scene();
    Scene.Start();

    oldTime = performance.now();
    requestAnimationFrame(GameLoop);
</script>

</html>